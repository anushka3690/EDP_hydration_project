<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyFlow: Stay Flow</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Add Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="background: linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 100%); font-family: 'Segoe UI', Arial, sans-serif;">

  <!-- Login/Registration Modal -->
  <div id="authModal" class="modal" style="display: block;">
    <div class="modal-content" style="max-width: 350px; margin: 10% auto; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,50,0.1);">
      <h2 id="authTitle" style="color: #0277bd; text-align: center; margin-bottom: 24px;">Login</h2>
      <form id="authForm">
        <div id="registerFields" style="display: none;">
          <label for="registerName">Name:</label>
          <input type="text" id="registerName" placeholder="Enter your name" required><br><br>
        </div>
        <label for="authEmail">Email:</label>
        <input type="email" id="authEmail" placeholder="Enter your email" required><br><br>
        <label for="authPassword">Password:</label>
        <input type="password" id="authPassword" placeholder="Enter your password" required><br><br>
        <button type="submit" id="authSubmitButton">Login</button>
      </form>
      <p id="authSwitchText">Don't have an account? <a href="#" id="switchToRegister">Register</a></p>
      <p id="authError" style="color: red; display: none;"></p>
    </div>
  </div>

  <div id="appContent" style="display: none; background: rgba(255,255,255,0.95); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,50,0.1); padding: 32px 24px; max-width: 1000px; margin: 24px auto;">
    <h1 style="color: #0288d1; letter-spacing: 2px; text-shadow: 0 2px 8px #b3e5fc; text-align: center; font-size: 2.2em; margin-bottom: 24px;">HyFlow: Stay Flow</h1>
    
    <!-- Buttons Row -->
    <div style="margin-bottom: 24px; display: flex; justify-content: space-between;">
      <div>
        <button id="homeButton" class="main-button home-btn">Home</button>
        <button id="connectButton" class="main-button connect-btn">Connect</button>
        <button class="tab-button main-button settings-btn" data-tab="settingsTab">Settings</button>
      </div>
      <button id="logoutButton" class="main-button logout-btn">Logout</button>
    </div>

    <!-- Vertical Tabs Navigation (top right) -->
    <div style="position: absolute; top: 100px; right: 48px; display: flex; flex-direction: column; align-items: flex-end; z-index: 10;">
      <div class="tabs vertical-tabs" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="tab-button vertical-tab" data-tab="hydrationStatusTab">
          <i class="tab-icon">ðŸ’§</i> Hydration Status
        </button>
        <button class="tab-button vertical-tab" data-tab="dashboardTab">
          <i class="tab-icon">ðŸ“Š</i> Dashboard
        </button>
        <button class="tab-button vertical-tab" data-tab="rawDataTab">
          <i class="tab-icon">ðŸ“‹</i> Raw Data
        </button>
      </div>
    </div>

    <!-- Home Section -->
    <div id="homeSection" style="margin-top: 24px; max-width: 800px;">
      <div class="welcome-card">
        <h2 style="color: #0288d1; margin-bottom: 16px;">Welcome to HyFlow!</h2>
        <p style="color: #555; margin-bottom: 20px;">Track your hydration levels, set goals, and maintain optimal health with our smart hydration monitoring system.</p>
      </div>
      
      <div id="hydrationImages" class="feature-card" style="display: flex; align-items: center; gap: 24px; margin: 24px 0;">
        <img src="WhatsApp Image 2025-04-22 at 11.29.21_9589edf1.jpg" alt="Drink Water" style="max-width: 140px; border-radius: 12px; border: none; box-shadow: 0 6px 16px rgba(0,0,150,0.1);">
        <img src="WhatsApp Image 2025-04-22 at 13.03.19_503532b3.jpg" alt="Stay Hydrated" style="max-width: 140px; border-radius: 12px; border: none; box-shadow: 0 6px 16px rgba(0,0,150,0.1);">
        <div style="font-size: 1.1em; max-width: 340px; color: #0277bd;">
          <strong style="font-size: 1.2em; display: block; margin-bottom: 8px;">Hydration is essential!</strong>
          Drink enough water every day to keep your body and mind healthy.<br>
          Your hydration sensor helps you stay on track and maintain optimal hydration levels throughout the day.
        </div>
      </div>
      
      <div class="info-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 24px;">
        <div class="info-card">
          <h3>Why Hydration Matters</h3>
          <p>Proper hydration improves energy levels, brain function, and physical performance while preventing headaches.</p>
        </div>
        <div class="info-card">
          <h3>How It Works</h3>
          <p>Our sensor measures your hydration status in real-time using bioimpedance and advanced ML algorithms.</p>
        </div>
        <div class="info-card">
          <h3>Get Started</h3>
          <p>Click "Connect" to pair your sensor, then set your daily hydration goal in the Hydration Status tab.</p>
        </div>
      </div>
    </div>
    
    <!-- Hydration Status Tab -->
    <div id="hydrationStatusTab" class="tab-content">
      <div id="hydrationTips" class="tips"></div>
      <div id="dailyTracker" class="tracker">
        <h2>Daily Hydration Tracker</h2>
        <progress id="hydrationProgress" value="0" max="100"></progress>
        <p id="hydrationMessage">Let's start!</p>
        <p>Current Intake: <span id="currentIntakeValue">0</span> ml / <span id="hydrationGoalValue">2000</span> ml</p>
      </div>
      <div id="waterIntakeControls" class="tracker">
        <h2>Manage Water Intake</h2>
        <button id="addWaterButton">Add 250ml</button>
        <button id="removeWaterButton">Remove 250ml</button>
      </div>
      <div id="goalSetting" class="goal">
        <h2>Set Your Hydration Goal</h2>
        <input type="number" id="hydrationGoal" placeholder="Enter goal in ml" />
        <button id="setGoalButton">Set Goal</button>
      </div>
      <div id="gamification" class="gamification">
        <h2>Achievements</h2>
        <p id="latestAchievement">Latest Achievement: None</p>
        <button id="toggleAchievementsButton">View Achievements</button>
        <div id="viewAchievements" class="saved-achievements" style="display: none;">
          <h3>All Achievements</h3>
          <ul id="savedAchievementsList"></ul>
        </div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="tab-content" style="display: none;">
      <canvas id="hydrationChart" width="400" height="200"></canvas>
      <div id="analyticsDashboard" class="dashboard">
        <h2>Hydration Analytics</h2>
        <canvas id="analyticsChart" width="400" height="200"></canvas>
        <div id="currentHydrationStatus">
          <h3>Current Hydration Status</h3>
          <p id="dashboardHydrationStatus">N/A</p>
          <p id="predictedResult">Predicted Result: N/A</p>
          <p id="lastPredictionTime">Last Updated: N/A</p>
          <p id="hydrationDuration">Duration: N/A</p>
        </div>
      </div>
    </div>

    <!-- Raw Data Tab -->
    <div id="rawDataTab" class="tab-content" style="display: none;">
      <div id="dataContainer">
        <div class="data">GSR: <span id="gsrValue">N/A</span></div>
        <div class="data">Accel Magnitude: <span id="accelValue">N/A</span></div>
        <div class="data">Gyro Magnitude: <span id="gyroValue">N/A</span></div>
        <div class="data">Magnetometer Magnitude: <span id="magValue">N/A</span></div>
        <div class="data">IR Value: <span id="irValue">N/A</span></div>
        <div class="data">Current Hydration Status: <span id="hydrationStatus">N/A</span></div>
        <div class="data">Sensor Status: <span id="sensorStatus">N/A</span></div>
      </div>
    </div>

    <!-- Settings Tab (as a tab, not modal) -->
    <div id="settingsTab" class="tab-content" style="display: none;">
      <div class="modal-content" style="box-shadow:none; border-radius:0; max-width:none;">
        <h2>Settings</h2>
        <form id="settingsForm">
          <label for="profilePicture">Profile Picture:</label>
          <input type="file" id="profilePicture" accept="image/*"><br><br>
          <label for="userName">Name:</label>
          <input type="text" id="userName" placeholder="Enter your name"><br><br>
          <label for="gender">Gender:</label>
          <select id="gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select><br><br>
          <label for="activityLevel">Activity Level:</label>
          <select id="activityLevel">
            <option value="sedentary">Sedentary</option>
            <option value="light">Light</option>
            <option value="moderate">Moderate</option>
            <option value="active">Active</option>
          </select><br><br>
          <button type="button" id="saveSettingsButton">Save</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- User Authentication Logic ---
    const authModal = document.getElementById('authModal');
    const appContent = document.getElementById('appContent');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authSubmitButton = document.getElementById('authSubmitButton');
    const authSwitchText = document.getElementById('authSwitchText');
    const switchToRegister = document.getElementById('switchToRegister');
    const registerFields = document.getElementById('registerFields');
    const authError = document.getElementById('authError');

    let isRegisterMode = false;
    let authToken = null;
    let userInfo = null;

    // Helper: Get user key for localStorage
    function getUserKey(suffix) {
      if (!userInfo || !userInfo.email) return null;
      return `hyflow_${userInfo.email}_${suffix}`;
    }

    // Load user-specific hydration data
    function loadUserHydrationData() {
      const goalKey = getUserKey('goal');
      const intakeKey = getUserKey('intake');
      const achievementsKey = getUserKey('achievements');
      hydrationGoal = parseInt(localStorage.getItem(goalKey)) || null;
      currentIntake = parseInt(localStorage.getItem(intakeKey)) || 0;
      const savedAchievements = JSON.parse(localStorage.getItem(achievementsKey) || "[]");
      achievements.length = 0;
      savedAchievements.forEach(a => achievements.push(a));
      // Update UI
      document.getElementById('hydrationGoalValue').textContent = hydrationGoal || 2000;
      document.getElementById('currentIntakeValue').textContent = currentIntake;
      updateHydrationTracker(0, true); // true = don't increment intake
      // Render achievements
      const list = document.getElementById('savedAchievementsList');
      list.innerHTML = "";
      achievements.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        list.appendChild(li);
      });
      document.getElementById('latestAchievement').textContent = achievements.length
        ? `Latest Achievement: ${achievements[achievements.length - 1]}`
        : "Latest Achievement: None";
    }

    // Save user-specific hydration data
    function saveUserHydrationData() {
      const goalKey = getUserKey('goal');
      const intakeKey = getUserKey('intake');
      const achievementsKey = getUserKey('achievements');
      if (goalKey) localStorage.setItem(goalKey, hydrationGoal || "");
      if (intakeKey) localStorage.setItem(intakeKey, currentIntake || "0");
      if (achievementsKey) localStorage.setItem(achievementsKey, JSON.stringify(achievements));
    }

    // Check if user is already logged in (using token)
    function checkAuth() {
      const token = localStorage.getItem('hyflow_token');
      if (token) {
        // Optionally, verify token with /me endpoint
        fetch('http://localhost:3000/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(user => {
          // Ensure userInfo has an email property
          if (!user.email) {
            // Try to get email from localStorage (if you saved it) or fallback
            const savedEmail = localStorage.getItem('hyflow_email');
            user.email = savedEmail || '';
          }
          userInfo = user;
          authToken = token;
          authModal.style.display = 'none';
          showAppContent();
          loadUserHydrationData(); // Load user-specific data
        })
        .catch(() => {
          localStorage.removeItem('hyflow_token');
          authModal.style.display = 'block';
          appContent.style.display = 'none';
        });
      } else {
        authModal.style.display = 'block';
        appContent.style.display = 'none';
      }
    }

    // Switch between login and register
    function handleAuthSwitch(e) {
      e.preventDefault();
      isRegisterMode = !isRegisterMode;
      if (isRegisterMode) {
        authTitle.textContent = 'Register';
        authSubmitButton.textContent = 'Register';
        registerFields.style.display = 'block';
        document.getElementById('registerName').setAttribute('required', 'required');
        authSwitchText.innerHTML = 'Already have an account? <a href="#" id="switchToRegister">Login</a>';
      } else {
        authTitle.textContent = 'Login';
        authSubmitButton.textContent = 'Login';
        registerFields.style.display = 'none';
        document.getElementById('registerName').removeAttribute('required');
        authSwitchText.innerHTML = 'Don\'t have an account? <a href="#" id="switchToRegister">Register</a>';
      }
      document.getElementById('switchToRegister').addEventListener('click', handleAuthSwitch);
    }

    // Attach only once on load
    document.getElementById('switchToRegister').addEventListener('click', handleAuthSwitch);

    // Handle login/register form submit
    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      console.log('Form submitted. Current mode:', isRegisterMode ? 'Register' : 'Login');
      authError.style.display = 'none';
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;

      // For debugging - check backend server availability
      fetch('http://localhost:3000/status')
        .then(res => {
          console.log('Backend server status response:', res.ok);
        })
        .catch(err => {
          console.error('Backend server unavailable:', err);
          authError.textContent = 'Backend server unavailable. Please start the server.';
          authError.style.display = 'block';
        });

      if (isRegisterMode) {
        const name = document.getElementById('registerName').value.trim();
        if (!name) {
          authError.textContent = 'Name is required.';
          authError.style.display = 'block';
          return;
        }
        
        console.log('Attempting to register with:', { name, email, password: '******' });
        
        fetch('http://localhost:3000/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        })
        .then(res => {
          console.log('Registration response status:', res.status);
          return res.json();
        })
        .then(data => {
          console.log('Registration response data:', data);
          if (data.error) {
            authError.textContent = data.error;
            authError.style.display = 'block';
          } else if (data.token) {
            localStorage.setItem('hyflow_token', data.token);
            localStorage.setItem('hyflow_email', email); // Save email for fallback
            userInfo = { email: email, name: data.name };
            authToken = data.token;
            authModal.style.display = 'none';
            showAppContent();
            loadUserHydrationData();
          } else {
            authError.textContent = 'Unexpected response format.';
            authError.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('Registration error:', err);
          authError.textContent = 'Registration failed. Is the server running?';
          authError.style.display = 'block';
        });
      } else {
        console.log('Attempting to login with:', { email, password: '******' });
        
        // Enhanced login code with better error handling
        fetch('http://localhost:3000/login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ email, password })
        })
        .then(res => {
          console.log('Login response status:', res.status);
          // Check if response is ok before trying to parse JSON
          if (!res.ok) {
            return res.json().then(data => {
              throw new Error(data.error || `HTTP error! status: ${res.status}`);
            });
          }
          return res.json();
        })
        .then(data => {
          console.log('Login successful:', data);
          
          if (!data.token) {
            throw new Error('No token received from server');
          }
          
          // Store the token and user info
          localStorage.setItem('hyflow_token', data.token);
          localStorage.setItem('hyflow_email', email); // Save email for fallback
          userInfo = { 
            email: email,
            name: data.name || 'User'
          };
          authToken = data.token;
          
          // Update UI
          authModal.style.display = 'none';
          showAppContent();
          
          // Load user data
          loadUserHydrationData();
        })
        .catch(err => {
          console.error('Login error:', err);
          authError.textContent = err.message || 'Login failed. Please check your credentials.';
          authError.style.display = 'block';
        });
      }
    });

    const serviceUUID = "12345678-1234-5678-1234-56789abcdef0";
    const characteristics = {
      gsr: "12345678-1234-5678-1234-56789abcdef1",
      accel: "12345678-1234-5678-1234-56789abcdef2",
      gyro: "12345678-1234-5678-1234-56789abcdef3",
      mag: "12345678-1234-5678-1234-56789abcdef4",
      ir: "12345678-1234-5678-1234-56789abcdef5"
    };

    let device, server, service, intervalId;

    const connectButton = document.getElementById('connectButton');

    connectButton.addEventListener('click', async () => {
      if (connectButton.textContent === "Connect") {
        try {
          connectButton.textContent = "Connecting...";
          connectButton.disabled = true;

          device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [serviceUUID]
          });

          device.addEventListener('gattserverdisconnected', onDisconnected);

          server = await device.gatt.connect();
          service = await server.getPrimaryService(serviceUUID);

          const gsrChar = await service.getCharacteristic(characteristics.gsr);
          const accelChar = await service.getCharacteristic(characteristics.accel);
          const gyroChar = await service.getCharacteristic(characteristics.gyro);
          const magChar = await service.getCharacteristic(characteristics.mag);
          const irChar = await service.getCharacteristic(characteristics.ir);

          async function updateValue(characteristic, elementId) {
            const value = await characteristic.readValue();
            const floatValue = value.getFloat32(0, true);
            document.getElementById(elementId).textContent = floatValue.toFixed(2);
            return floatValue;
          }

          const hydrationChartCtx = document.getElementById('hydrationChart').getContext('2d');
          const hydrationChart = new Chart(hydrationChartCtx, {
            type: 'line',
            data: {
              labels: [], // Time labels
              datasets: [{
                label: 'Hydration Status',
                data: [], // Hydration status values
                borderColor: 'blue',
                borderWidth: 2,
                fill: false,
              }]
            },
            options: {
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Time'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Hydration Status'
                  }
                }
              }
            }
          });

          function showNotification(message) {
            if (Notification.permission === "granted") {
              new Notification(message);
            } else if (Notification.permission !== "denied") {
              Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                  new Notification(message);
                }
              });
            }
          }

          function playAlarm() {
            const alarm = new Audio('alarm.mp3'); // Ensure alarm.mp3 is in the same directory
            alarm.play();
          }

          intervalId = setInterval(async () => {
            const gsr = await updateValue(gsrChar, 'gsrValue');
            const accel = await updateValue(accelChar, 'accelValue');
            const gyro = await updateValue(gyroChar, 'gyroValue');
            const mag = await updateValue(magChar, 'magValue');
            const ir = await updateValue(irChar, 'irValue');

            let mappedStatus;
            let predictedStatus; // Declare predictedStatus outside try block
            try {
              const response = await fetch('http://localhost:5000/sensor-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gsr, accel, gyro, mag, ir })
              });
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const result = await response.json();
              console.log('Prediction received from backend:', result); // Debug: Log backend response
              predictedStatus = result.hydration_status; // ML model output

              // Map backend status format to frontend format
              const statusMapping = {
                'dehydrated': 'Dehydrated',
                'hydrated': 'Hydrated',
                'mildly_dehydrated': 'Mildly Dehydrated'
              };

              // Convert the status format if it exists in our mapping
              if (predictedStatus in statusMapping) {
                predictedStatus = statusMapping[predictedStatus];
              }

              // Add a fallback for invalid hydration statuses
              const validStatuses = ["Hydrated", "Dehydrated", "Possibly Dehydrated", "Mildly Dehydrated"];
              mappedStatus = validStatuses.includes(predictedStatus) ? predictedStatus : "Unknown";

              // Log the received prediction for debugging
              console.log('Received hydration status:', predictedStatus);
              console.log('Mapped hydration status:', mappedStatus);
            } catch (error) {
              console.error('Error sending data or receiving prediction:', error);
              mappedStatus = "Unknown";
              predictedStatus = "N/A"; // Set predictedStatus to N/A in case of error
            }

            // Update hydration status in both hydration tab and dashboard
            document.getElementById('hydrationStatus').textContent = mappedStatus;
            updateDashboardHydrationStatus(mappedStatus);

            // Update predicted result in the dashboard
            document.getElementById('predictedResult').textContent = `Predicted Result: ${predictedStatus}`;

            // Display messages and trigger notifications/alarms based on predicted result
            const dashboardHydrationMessage = document.getElementById('dashboardHydrationStatus'); // Dashboard section

            if (mappedStatus === "Hydrated") {
              dashboardHydrationMessage.textContent = "Well done! Stay hydrated.";
            } else if (mappedStatus === "Mildly Dehydrated") {
              dashboardHydrationMessage.textContent = "Drink some electrolytes.";
              showNotification("Mild dehydration detected. Please drink some electrolytes.");
            } else if (mappedStatus === "Dehydrated") {
              dashboardHydrationMessage.textContent = "Please visit a doctor.";
              showNotification("Severe dehydration detected. Please visit a doctor immediately.");
              playAlarm();
            } else {
              dashboardHydrationMessage.textContent = "Unknown hydration status.";
            }

            // Update sensor status based on IR value
            if (ir < 40000) {
              document.getElementById('sensorStatus').textContent = "Please wear your sensor";
            } else {
              document.getElementById('sensorStatus').textContent = mappedStatus === "Unknown" ? "Wear your sensor" : "Stay hydrated";
            }

            // Update chart if status is valid
            if (mappedStatus !== "Unknown") {
              const currentTime = new Date().toLocaleTimeString();
              hydrationChart.data.labels.push(currentTime);
              hydrationChart.data.datasets[0].data.push(
                mappedStatus.includes("Dehydrated") ? 0 : mappedStatus.includes("Hydrated") ? 2 : 1
              );

              // Keep only the latest 15 predictions
              if (hydrationChart.data.labels.length > 15) {
                hydrationChart.data.labels = hydrationChart.data.labels.slice(-15);
                hydrationChart.data.datasets[0].data = hydrationChart.data.datasets[0].data.slice(-15);
              }

              hydrationChart.update();
            }
          }, 2000); // Update every 2 seconds

          connectButton.textContent = "Disconnect";
          connectButton.disabled = false;
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to connect to the sensor. Please try again.');
          connectButton.textContent = "Connect";
          connectButton.disabled = false;
        }
      } else if (connectButton.textContent === "Disconnect") {
        if (device && device.gatt.connected) {
          device.gatt.disconnect();
        }
      }
    });

    function onDisconnected() {
      clearInterval(intervalId);
      connectButton.textContent = "Connect";
      connectButton.disabled = false;

      document.getElementById('gsrValue').textContent = "N/A";
      document.getElementById('accelValue').textContent = "N/A";
      document.getElementById('gyroValue').textContent = "N/A";
      document.getElementById('magValue').textContent = "N/A";
      document.getElementById('irValue').textContent = "N/A";
      document.getElementById('hydrationStatus').textContent = "N/A";
      document.getElementById('sensorStatus').textContent = "N/A";
      document.getElementById('hydrationMessage').textContent = "";

      alert('Device disconnected.');
    }

    let lastPrediction = null;
    let lastPredictionTime = null;
    let durationInterval;

    function updateDashboardHydrationStatus(status) {
      const currentTime = new Date();

      // If the status changes, reset the timer
      if (status !== lastPrediction) {
        lastPrediction = status;
        lastPredictionTime = currentTime;

        // Reset the duration display
        document.getElementById('hydrationDuration').textContent = `Duration: 0 minutes`;

        // Clear any existing interval and start a new one
        if (durationInterval) clearInterval(durationInterval);
        durationInterval = setInterval(() => {
          const now = new Date();
          const duration = Math.floor((now - lastPredictionTime) / 60000); // Duration in minutes
          document.getElementById('hydrationDuration').textContent = `Duration: ${duration} minutes`;
        }, 60000); // Update every minute
      }

      // Update the hydration status and last updated time
      document.getElementById('dashboardHydrationStatus').textContent = status;
      document.getElementById('lastPredictionTime').textContent = `Last Updated: ${currentTime.toLocaleTimeString()}`;

      // Save the status and time to hydration analytics
      updateAnalyticsChart(status, currentTime);
    }

    function updateAnalyticsChart(status, time) {
      const statusMapping = { "Hydrated": 3, "Mildly Dehydrated": 2, "Dehydrated": 1, "Possibly Dehydrated": 0 };
      const level = statusMapping[status] !== undefined ? statusMapping[status] : -1;

      analyticsChart.data.labels.push(time.toLocaleTimeString());
      analyticsChart.data.datasets[0].data.push(level);

      // Keep only the latest 10 entries
      if (analyticsChart.data.labels.length > 10) {
        analyticsChart.data.labels.shift();
        analyticsChart.data.datasets[0].data.shift();
      }

      analyticsChart.update();
    }

    // Hydration Tips
    const tips = [
      "Drink water first thing in the morning.",
      "Carry a water bottle with you.",
      "Eat water-rich foods like fruits and vegetables.",
      "Avoid sugary drinks; opt for water instead.",
      "Start your day with a glass of water to kickstart hydration.",
      "Set hourly reminders to take a few sips.",
      "Drink before, during, and after exercise to replace lost fluids."
    ];
    document.getElementById('hydrationTips').textContent = tips[Math.floor(Math.random() * tips.length)];

    // Daily Hydration Tracker
    let hydrationGoal = null; // Default goal is null until set
    let currentIntake = 0;

    document.getElementById('setGoalButton').addEventListener('click', () => {
      hydrationGoal = parseInt(document.getElementById('hydrationGoal').value);
      if (hydrationGoal && hydrationGoal > 0) {
        document.getElementById('hydrationGoalValue').textContent = hydrationGoal;
        saveUserHydrationData();
        alert(`Hydration goal set to ${hydrationGoal} ml.`);
      } else {
        alert("Please enter a valid hydration goal.");
      }
    });

    document.getElementById('addWaterButton').addEventListener('click', () => {
      if (!hydrationGoal) {
        alert("Please set your hydration goal first!");
        return;
      }
      updateHydrationTracker(250); // Add 250ml
    });

    document.getElementById('removeWaterButton').addEventListener('click', () => {
      if (!hydrationGoal) {
        alert("Please set your hydration goal first!");
        return;
      }
      updateHydrationTracker(-250); // Remove 250ml
    });

    const achievements = []; // Array to store all achievements

    // Function to add a new achievement
    function addAchievement(message) {
      if (!achievements.includes(message)) {
        achievements.push(message);

        // Update the latest achievement outside the "View Achievements" section
        document.getElementById('latestAchievement').textContent = `Latest Achievement: ${message}`;

        // Add the new achievement to the "View Achievements" list
        const list = document.getElementById('savedAchievementsList');
        const listItem = document.createElement('li');
        listItem.textContent = message;
        list.appendChild(listItem);

        saveUserHydrationData();
      }
    }

    // Function to update hydration tracker and handle achievements
    // Add skipSave param to avoid saving on initial load
    function updateHydrationTracker(intake, skipSave) {
      currentIntake = Math.max(0, currentIntake + intake); // Prevent negative intake
      const percentage = hydrationGoal ? Math.min((currentIntake / hydrationGoal) * 100, 100) : 0;
      document.getElementById('hydrationProgress').value = percentage;
      document.getElementById('currentIntakeValue').textContent = currentIntake;

      // Update motivational message based on progress
      const hydrationMessage = document.getElementById('hydrationMessage');
      if (percentage === 0) {
        hydrationMessage.textContent = "Let's start!";
      } else if (percentage > 0 && percentage <= 25) {
        hydrationMessage.textContent = "You are doing well!";
      } else if (percentage > 25 && percentage <= 50) {
        hydrationMessage.textContent = "We almost completed our target!";
      } else if (percentage > 50 && percentage <= 75) {
        hydrationMessage.textContent = "Come on, you can do it!";
      } else if (percentage > 75 && percentage < 100) {
        hydrationMessage.textContent = "Almost there, keep going!";
      } else if (percentage === 100) {
        hydrationMessage.textContent = "Yeah, you did it!";
      }

      // Add achievements dynamically based on hydration goal completion
      if (hydrationGoal) {
        if (currentIntake >= hydrationGoal * 1.5 && !achievements.includes("Drank 1.5x your hydration goal!")) {
          addAchievement("Drank 1.5x your hydration goal!");
        }
        if (currentIntake >= hydrationGoal * 2 && !achievements.includes("Drank 2x your hydration goal! Amazing!")) {
          addAchievement("Drank 2x your hydration goal! Amazing!");
        }
        if (currentIntake >= hydrationGoal * 3 && !achievements.includes("Drank 3x your hydration goal! Incredible!")) {
          addAchievement("Drank 3x your hydration goal! Incredible!");
        }
      }
      if (!skipSave) saveUserHydrationData();
    }

    // Toggle visibility of the "View Achievements" section
    document.getElementById('toggleAchievementsButton').addEventListener('click', () => {
      const achievementsDiv = document.getElementById('viewAchievements');
      const isHidden = achievementsDiv.style.display === 'none';
      achievementsDiv.style.display = isHidden ? 'block' : 'none';
      document.getElementById('toggleAchievementsButton').textContent = isHidden ? 'Hide Achievements' : 'View Achievements';
    });

    // Analytics Dashboard
    const analyticsCtx = document.getElementById('analyticsChart').getContext('2d');
    const analyticsChart = new Chart(analyticsCtx, {
      type: 'bar',
      data: {
        labels: [], // Time labels
        datasets: [{
          label: 'Hydration Levels',
          data: [], // Hydration data
          backgroundColor: 'rgba(0, 123, 255, 0.5)',
          borderColor: 'rgba(0, 123, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Hydration Level' } }
        }
      }
    });

    function updateAnalyticsChart(level) {
      const currentTime = new Date().toLocaleTimeString();
      analyticsChart.data.labels.push(currentTime);
      analyticsChart.data.datasets[0].data.push(level);
      if (analyticsChart.data.labels.length > 10) {
        analyticsChart.data.labels.shift();
        analyticsChart.data.datasets[0].data.shift();
      }
      analyticsChart.update();
    }

    // Weather-Based Hydration Suggestions
    async function fetchWeatherData() {
      try {
        const response = await fetch('https://api.openweathermap.org/data/2.5/weather?q=London&appid=YOUR_API_KEY');
        const data = await response.json();
        const temp = (data.main.temp - 273.15).toFixed(1); // Convert Kelvin to Celsius
        document.getElementById('weatherInfo').textContent = `Current temperature: ${temp}Â°C. Stay hydrated!`;
      } catch (error) {
        document.getElementById('weatherInfo').textContent = "Failed to fetch weather data.";
      }
    }
    fetchWeatherData();

    // Tab Switching Logic
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        document.getElementById('homeSection').style.display = 'none';
        tabContents.forEach(content => content.style.display = 'none');
        document.getElementById(button.dataset.tab).style.display = 'block';
      });
    });

    // Hide all main sections except home
    function showHomeSection() {
      document.getElementById('homeSection').style.display = 'block';
      document.getElementById('hydrationStatusTab').style.display = 'none';
      document.getElementById('dashboardTab').style.display = 'none';
      document.getElementById('rawDataTab').style.display = 'none';
      document.getElementById('settingsTab').style.display = 'none';
    }

    // Home button logic
    document.getElementById('homeButton').addEventListener('click', showHomeSection);

    // On login, show home section by default
    function showAppContent() {
      appContent.style.display = 'block';
      showHomeSection();
    }

    // Logout button logic
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.removeItem('hyflow_token');
      authToken = null;
      userInfo = null;
      
      // Reset the auth form to initial state
      isRegisterMode = false;
      authTitle.textContent = 'Login';
      authSubmitButton.textContent = 'Login';
      registerFields.style.display = 'none';
      document.getElementById('registerName').removeAttribute('required');
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
      document.getElementById('registerName').value = '';
      authSwitchText.innerHTML = 'Don\'t have an account? <a href="#" id="switchToRegister">Register</a>';
      
      // Re-attach event listener to the register link
      document.getElementById('switchToRegister').addEventListener('click', handleAuthSwitch);
      
      // Hide app content and show login form
      appContent.style.display = 'none';
      authModal.style.display = 'block';
      
      // Clear any previous error messages
      authError.style.display = 'none';
      
      console.log('Logout complete, form reset to login state');
    });

    // Move this to the very end of the script, after all functions and event listeners
    window.addEventListener('load', () => {
      checkAuth();
    });
  </script>
</body>
</html>
